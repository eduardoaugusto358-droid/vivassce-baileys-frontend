version: '3.8'

services:
  baileys-frontend:
    image: ghcr.io/seu-usuario/vivassce-baileys-frontend:latest
    
    environment:
      # URL do backend (usada no build)
      - VITE_API_URL=${VITE_API_URL:-https://api.stackleys.iconverseagora.com}
    
    networks:
      - traefik-public
    
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        # Habilitar Traefik
        - "traefik.enable=true"
        
        # Rede do Traefik
        - "traefik.docker.network=traefik-public"
        
        # HTTP Router
        - "traefik.http.routers.baileys-frontend.rule=Host(`${FRONTEND_DOMAIN:-baileys.iconverseagora.com}`)"
        - "traefik.http.routers.baileys-frontend.entrypoints=websecure"
        - "traefik.http.routers.baileys-frontend.tls=true"
        - "traefik.http.routers.baileys-frontend.tls.certresolver=letsencrypt"
        
        # Service
        - "traefik.http.services.baileys-frontend.loadbalancer.server.port=80"
        
        # Redirect HTTP to HTTPS
        - "traefik.http.routers.baileys-frontend-http.rule=Host(`${FRONTEND_DOMAIN:-baileys.iconverseagora.com}`)"
        - "traefik.http.routers.baileys-frontend-http.entrypoints=web"
        - "traefik.http.routers.baileys-frontend-http.middlewares=redirect-to-https@docker"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
        
        # Security Headers
        - "traefik.http.middlewares.baileys-headers.headers.frameDeny=true"
        - "traefik.http.middlewares.baileys-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.baileys-headers.headers.browserXssFilter=true"
        - "traefik.http.routers.baileys-frontend.middlewares=baileys-headers@docker"
        
        # Watchtower
        - "com.centurylinklabs.watchtower.enable=true"
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  traefik-public:
    external: true
